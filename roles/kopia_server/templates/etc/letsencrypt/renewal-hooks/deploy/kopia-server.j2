#!/bin/bash
set -eu
set -o pipefail

# This script is run by certbot after renewing certificates
# It copies the certificates to a location where kopia-server can access them

# Create SSL directory if it doesn't exist
SSL_DIR="{{ kopia_server__home }}/ssl"
mkdir -p "${SSL_DIR}"

# Copy the certificates
cp "$RENEWED_LINEAGE/fullchain.pem" "${SSL_DIR}/fullchain.pem"
cp "$RENEWED_LINEAGE/privkey.pem" "${SSL_DIR}/privkey.pem"

# Set appropriate permissions
chown backup:backup "${SSL_DIR}/fullchain.pem" "${SSL_DIR}/privkey.pem"
chmod 600 "${SSL_DIR}/fullchain.pem" "${SSL_DIR}/privkey.pem"

# Restart the kopia-server service to pick up the new certificates
systemctl restart kopia-server.service
